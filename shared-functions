#!/bin/sh -x

function klog {
  {
    typeset message=$1
    echo "`date +%Y%m%d.%H.%M.%S`: $message"
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf klog

function kmail {
  {
    typeset recipient=$1
    typeset subject=$2
    typeset message=$3
    if [[ "$SEND_MAIL" = "true" ]]
      then
        klog "mailing recipent: $recipient"
        echo "$message" | mail -s "$subject" $recipient
    else
      echo "SEND_MAIL is turned off"
    fi 
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kmail

function kexec {
  {
    typeset command=$1
    klog "executing command: $command"
    eval $command
    typeset return_status=$?
    if [[ "$return_status" != "0" ]]
      then
        kend $return_status
    fi
    return $return_status
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kexec

function kend {
  {
    typeset exit_status=$1
    klog "ending with exit status: $exit_status"
    if [[ "$exit_status" != "0" ]]
      then
        kmail $APPLICATION_CFG_MAIL_LIST "$SCRIPT_NAME has errors" "`cat $SCRIPT_LOG`"
    fi
    exit $exit_status
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kend

function ksetprops {
  {
    typeset environment=$1
    typeset user=$DATABASE_APPLICATION_CODE$environment
    typeset schema="`echo $user | tr a-z A-Z`"
    typeset password=$environment"174"$DATABASE_APPLICATION_CODE
    kexec "echo \"application=$APPLICATION\" > $ANT_PROPERTIES_FILE"
    kexec "echo \"environment=$environment\" >> $ANT_PROPERTIES_FILE"
    kexec "echo \"schema=$schema\" >> $ANT_PROPERTIES_FILE"
    kexec "echo \"datasource.username=$user\" >> $ANT_PROPERTIES_FILE"
    kexec "echo \"datasource.password=$password\" >> $ANT_PROPERTIES_FILE"
    kexec "echo \"database.cvs.module=$DATABASE_CVS_MODULE\" >> $ANT_PROPERTIES_FILE"
    kexec "echo \"application.database.cvs.module=$APPLICATION_DATABASE_CVS_MODULE\" >> $ANT_PROPERTIES_FILE"
	kexec "echo \"tag.properties.file=$DEPLOY_BASE_DIRECTORY/$environment/$JAVA_APPLICATION_CODE/$DEPLOY_TAG_FILE\" >> $ANT_PROPERTIES_FILE"
    kexec "cat $ANT_PROPERTIES_TEMPLATE >> $ANT_PROPERTIES_FILE" 
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf ksetprops

function kexport {
  {
    typeset environment=$1
    ksetprops $environment
    klog "exporting from environment: $environment"
	kexec "cvs -q checkout $APPLICATION_DATABASE_CVS_MODULE"
    typeset ant_arguments="-Djava.properties.file="$DEPLOY_BASE_DIRECTORY/$environment/$JAVA_APPLICATION_CODE/$DEPLOY_PROPERTIES_FILE" -Ddatabase.properties.file="$ANT_PROPERTIES_FILE
    kexec "$ANT_COMMAND $ant_arguments -f $ANT_BUILD_FILE export"
    cvs -q add $APPLICATION_DATABASE_CVS_MODULE/*
    cvs -q add $APPLICATION_DATABASE_CVS_MODULE/doc/*
	cvs remove $APPLICATION_DATABASE_CVS_MODULE
    kexec "cvs -q update $APPLICATION_DATABASE_CVS_MODULE"
    kexec "cvs commit -m \"daily export\" $APPLICATION_DATABASE_CVS_MODULE"
    kexec "rm -rf $APPLICATION_DATABASE_CVS_MODULE"
    return 0
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kexport

function kimport {
  {
    typeset environment=$1
    klog "importing into environment: $environment"
    typeset ant_arguments="-Djava.properties.file="$DEPLOY_BASE_DIRECTORY/$environment/$JAVA_APPLICATION_CODE/$DEPLOY_PROPERTIES_FILE" -Ddatabase.properties.file="$ANT_PROPERTIES_FILE
    kexec "$ANT_COMMAND $ant_arguments -f $ANT_BUILD_FILE import"
    return 0
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kimport

function kdailytag {
  {
    branch=$1
    old_build_number=`cat $BUILD_NUMBER_FILE`
    new_build_number=`expr $old_build_number + 1`
    new_build_tag="build-"$new_build_number
    kexec "echo $new_build_number > $BUILD_NUMBER_FILE"
    klog "tagging branch: $branch of application java and database modules with new_build_tag: $new_build_tag"
    kexec "cvs -q rtag -d $new_build_tag $APPLICATION_JAVA_CVS_MODULE"
    kexec "cvs -q rtag -r $branch $new_build_tag $APPLICATION_JAVA_CVS_MODULE"
    kexec "cvs -q rtag -d $new_build_tag $APPLICATION_DATABASE_CVS_MODULE"
    kexec "cvs -q rtag $new_build_tag $APPLICATION_DATABASE_CVS_MODULE"
	# remove when ditch old db process
    kexec "cvs -q rtag -d $new_build_tag kuali_database"
    kexec "cvs -q rtag $new_build_tag kuali_database"
	# remove when ditch old db process
    return 0
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kdailytag

function kpurge {
  {
    directory=$1
    number_of_days_old=$2
    klog "purging items from directory: $directory with number_of_days_old: $number_of_days_old"
    kexec "find $directory -type f -atime +$number_of_days_old -print -exec rm -f {} \;"
    return 0
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kpurge

function kupdate {
  {
    typeset environment=$1
    typeset use_standard_tag=$2
    typeset deploy_web_application=$3
    typeset do_database_update=$4
    typeset tag_file=$DEPLOY_BASE_DIRECTORY/$environment/$JAVA_APPLICATION_CODE/$DEPLOY_TAG_FILE
    typeset tag_file_constant=project.cvs.tag=
    klog "updating environment: $environment with use_standard_tag: $use_standard_tag, deploy_web_application: $deploy_web_application, static_content_node: $static_content_node, and do_database_update: $do_database_update"
    if [[ "$use_standard_tag" = "true" ]]
      then
        klog "overwriting $tag_file"
        typeset tag=build-`cat $BUILD_NUMBER_FILE`
        kexec "rm -rf $tag_file"
        kexec "echo $tag_file_constant$tag > $tag_file"
    else
        typeset tag_file_contents=`cat $tag_file`
        typeset tag=${tag_file_contents#$tag_file_constant}
    fi
    klog "tag is $tag"
    ksetprops $environment
    if [[ "$do_database_update" = "true" ]]
      then
        kimport $environment
    fi
    if [[ "$deploy_web_application" = "true" ]]
      then
        klog "deploying web application"
        kexec "$DEPLOY_COMMAND $JAVA_APPLICATION_CODE $environment"
    fi
    klog "purging work"
    kexec "$WORK_PURGE_COMMAND $JAVA_APPLICATION_CODE $environment"
    return 0
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf kupdate

function koldexport {
  {
    typeset schema=kuldba
    typeset dump_file=$schema".dmp"
    typeset DATA_SERVER=esdb12-k.uits.indiana.edu
    typeset DBA_USER=ora1010
    typeset DBA_BASE_DIRECTORY=/opt/oracle
    typeset DBA_LOGS_DIRECTORY=/var/brte/DBA
    typeset DBA_PROGRAM_DIRECTORY=$DBA_BASE_DIRECTORY/admin
    typeset DBA_WORKING_DIRECTORY=$DBA_BASE_DIRECTORY/exp/KUALI
    typeset DBA_EXPORT_COMMAND=dba_export_kul.sh
    typeset DBA_IMPORT_COMMAND=dba_import_kul.sh
    typeset BRTE_USER=kuldevb

    kexec "cvs -q checkout kuali_database"
    typeset old_zip_name=`find kuali_database/ -name $schema-*.tgz -print`
    kexec "rm -f $old_zip_name"
    kexec "cvs -q delete $old_zip_name"
    kexec "cvs commit -m \"automated daily export\" kuali_database"
    typeset new_zip_name=kuali_database/$schema-`date +%Y%m%d%H%M%S`.tgz
    klog "replacing old_zip_name: $old_zip_name with new_zip_name:  $new_zip_name"
    kexec "ssh $BRTE_USER@$DATA_SERVER \"sudo -H -u $DBA_USER $DBA_PROGRAM_DIRECTORY/$DBA_EXPORT_COMMAND $schema\""
    kexec "scp $BRTE_USER@$DATA_SERVER:$DBA_WORKING_DIRECTORY/$schema\"_exp.dmp\" $dump_file"
    kexec "tar -zcf $new_zip_name $dump_file"
    kexec "cvs -q add -kb $new_zip_name"
    kexec "cvs commit -m \"automated daily export\" kuali_database"
    kexec "rm -rf kuali_database"
    kexec "rm -f $dump_file"
    return 0
  } >> $SCRIPT_LOG 2>&1
}
typeset -xf koldexport