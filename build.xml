<?xml version="1.0"?>
<project name="kul-cfg-envs" default="init-database-properties" basedir=".">
	<target name="init-java-properties">
		<property file="${java.properties.file}" />
		<condition property="import.into.mysql">
			<equals arg1="${ojb.platform}" arg2="MySQL" />
		</condition>
		<property file="${database.properties.file}" />
		<property file="${base.directory}/build.properties" />
	</target>
	
	<target name="init-mysql-properties" depends="init-java-properties" if="import.into.mysql">
		<property file="${base.directory}/mysql-impex.properties" />
	</target>

	<target name="init-database-properties" depends="init-mysql-properties">
		<property file="${base.directory}/oracle-impex.properties" />
		<property name="impex.build.file" value="${base.directory}/${database.cvs.module}/impex/build.xml" />
		<property file="${tag.properties.file}" />
		<loadfile property="impex-build.properties" srcfile="impex-build.properties"><filterchain><expandproperties /></filterchain></loadfile>
		<delete file="${user.home}/impex-build.properties" />
		<echo message="${impex-build.properties}" file="${user.home}/impex-build.properties" />
	</target>
		
	<target name="checkout-database-project" depends="init-database-properties">
		<cvspass cvsroot="${project.cvs.root}" password="${project.cvs.anonpassword}" passfile="${user.home}/.cvspass" />
		<cvs command="checkout ${application.database.cvs.module}" dest="${working.directory}" />
	</target>
	
	<target name="delete-database-project" depends="init-database-properties">
		<delete dir="${working.directory}/${application.database.cvs.module}" />
		<delete file="${working.directory}/velocity.log" />
	</target>
	
	<target name="update-database-project" depends="checkout-database-project">
		<delete>
			<fileset dir="${working.directory}/${torque.working.directory}" includes="${application.database.xml},${application.database.docs}.css,${application.database.docs}.html,${application.database.incremental.file}" />
		</delete>
		<ant antfile="${impex.build.file}" target="export" inheritall="false" />
		<property name="cvs.project.directory" value="${working.directory}/${application.database.cvs.module}" />
		<cvs command="add ${cvs.project.directory}/${application.database.xml}" />
		<cvs command="add ${cvs.project.directory}/${application.database.docs}" />
		<echo message="" file="${cvs.project.directory}/${application.database.incremental.file}" />
		<cvs command="add ${cvs.project.directory}/${application.database.incremental.file}" />
		<cvs command="update ${cvs.project.directory}" />
		<cvs command="commit -m 'daily export' ${cvs.project.directory}" />
	</target>

	<target name="update-database" depends="checkout-database-project">
		<ant antfile="${impex.build.file}" target="empty-schema" inheritall="false" />
		<ant antfile="${impex.build.file}" target="import" inheritall="false" />
	</target>

	<target name="export" depends="update-database-project,delete-database-project" />

	<target name="import" depends="update-database,delete-database-project" />
</project>