<?xml version="1.0" encoding="UTF-8"?>
<!--
 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.
-->
<project name="kuali_db" default="help" basedir=".">

	<target name="help">
		<property name="source.zip.location" location="${source.zip}" />
		<property name="target.zip.location" location="${target.zip}" />

		<echo>
**********************************
KFS Database Import/Export Utility
**********************************

Setup:
    1) set the ANT_OPTS environment variable to "-Xmx1g"
            Windows: set ANT_OPTS=-Xmx1g
            Unix:    export ANT_OPTS=-Xmx1g
    2) The database schema/user must already be in place and empty prior to running the import.
    3) The currently supported database types are
            Export: oracle
            Import: mysql, oracle
    4) Copy the impex-build.properties.sample file into your home directory (${user.home}) 
       as impex-build.properties.  Update the properties appropriately for your database instance and driver directory.
			
       FIXME: several file locations in this help are different than what the process actually uses.

Main Targets: 
         import ==> Extracts the database schema and data from the archive given in ${source.zip.location} 
                    and installs it into the database specified by the import.xxx properties in 
                    impex-build.properties.

         export ==> Extracts the structure and data from the database and schema specified by 
                    the export.xxx properties in impex-build.properties and packages it up 
                    into ${target.zip.location}.
			
Other Targets:
    Export Related:
         jdbc-to-xml          ==> Extracts the database schema given in the import.xxx parameters into 
                                  a single xml file (${torque.schema.dir}/schema.xml)
         export-data          ==> Exports all data from the specified schema into an XML file per table.
                                  Each tag in the file represents a table row.  Each column is an attribute of the tag.
         create-data-dtd      ==> Generates a single DTD file for the above data XML files.
         doc                  ==> Generates HTML cross-linked documentation for the database schema.
         package-export       ==> Packages the export into a single zip file: ${target.zip}

    Import Related:			
         unpack-export        ==> Unpacks the source zip file (${source.zip}) into the ${torque.schema.dir} directory.
         create-ddl           ==> Creates ${torque.schema.dir}/sql/schema.sql and 
                                  ${torque.schema.dir}/sql/schema-constraints.sql from the 
                                  ${torque.schema.dir}/schema.xml file.
         dataxml-to-sql       ==> Creates SQL files (one per table) from the data XML files.  
                                  This process runs in 5 threads to speed the process.  
                                  (See: dataxml-file-to-sql-file and external-run-dataxml-load targets)
         apply-ddl            ==> Runs the ${torque.schema.dir}/sql/schema.sql into the database to 
                                  create all the tables, views, sequences, primary keys, and indexes.
         apply-data-sql       ==> Runs all data SQL files into the database.
         apply-constraint-ddl ==> Runs the ${torque.schema.dir}/sql/schema-constraints.sql into 
                                  the database to create all foreign key constraints.
			
Note: Due to java native library classloader issues, the export routine (and possibly import) does not work 
      when using a type 3 JDBC driver which relies upon a native OS library (*.dll,*.so).  If you must use 
      such a driver, you must run the dependencies of the export and import tasks separately.
		</echo>

	</target>

	<property name="impex.dir" value="impex" />
    <property name="impex.templates.dir" value="${impex.dir}/templates" />
    <property name="build.properties" value="build.properties"/>
    <property name="impex.contextProperties" value="${build.properties}"/>
	<property file="${user.home}/impex-build.properties" />
    <property file="${build.properties}" />
    <property name="lib.dir" value="${impex.dir}/lib"/>

	<!--
    The default.properties file will map old properties to the new ones along
    with setting the correct defaults.
    -->
	<property resource="org/apache/torque/default.properties">
		<classpath>
			<path refid="torque-classpath" />
		</classpath>
	</property>
    <path id="torque-classpath">
        <pathelement location="${impex.dir}/kuali-impextasks.jar" />
        <pathelement path="${impex.templates.dir}" />
        <fileset dir="${lib.dir}" includes="**/*.jar" />
        <fileset dir="${drivers.directory}" includes="${drivers.file.pattern}" />
    </path>

	<!--
    Do forward declarations of all of our tasks to
    centralize them and clean up the targets.
  -->
	<target name="inittasks">
		<mkdir dir="${torque.schema.dir}" />
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
			<classpath>
				<pathelement location="${lib.dir}/ant-contrib-1.0b3.jar" />
			</classpath>
		</taskdef>
		<taskdef name="torque-data-model"
		         classpathref="torque-classpath"
		         classname="org.apache.torque.task.TorqueDataModelTask"
		/>
		<taskdef name="torque-data-dump"
		         classpathref="torque-classpath"
		         classname="org.kuali.core.db.torque.KualiTorqueDataDumpTask"
		/>
		<taskdef name="torque-data-sql"
		         classpathref="torque-classpath"
		         classname="org.kuali.core.db.torque.KualiTorqueDataSqlTask"
		/>
		<taskdef name="torque-doc"
		         classpathref="torque-classpath"
		         classname="org.apache.torque.task.TorqueDocumentationTask"
		/>
		<taskdef name="torque-jdbc-transform"
		         classpathref="torque-classpath"
		         classname="org.kuali.core.db.torque.KualiTorqueJdbcTransformTask"
		/>
		<taskdef name="torque-sql"
		         classpathref="torque-classpath"
		         classname="org.kuali.core.db.torque.KualiTorqueSQLTask"
		/>
		<taskdef name="torque-sql-exec"
		         classpathref="torque-classpath"
		         classname="org.apache.torque.task.TorqueSQLExec"
		/>
	</target>

	<target name="create-ddl"
	        description="==> generates the SQL for your project"
			depends="inittasks"
	>

		<echo message="+------------------------------------------+" />
		<echo message="|                                          |" />
		<echo message="| Generating SQL for YOUR Torque project!  |" />
		<echo message="|                                          |" />
		<echo message="+------------------------------------------+" />

		<echo message="loading templates from classpath" />

		<mkdir dir="${torque.sql.dir}"/>
		
		<property name="torque.sql.absolute.dir" location="${torque.sql.dir}" />
		<!-- above works around a problem with torque-data-dump getting passed a relative directory, and not working right if tbe process was started from a directory other than ant's basedir -->

		<torque-sql contextProperties="${impex.contextProperties}"
		            controlTemplate="${torque.template.sql}"
		            outputDirectory="${torque.sql.absolute.dir}"
		            outputFile="report.sql.generation"
		            sqldbmap="${torque.sql.dir}/sqldb.map"
		            targetDatabase="${import.torque.database}"
		            templatePath="${torque.templatePath}"
		            useClasspath="true"
		>
			<fileset dir="${torque.schema.dir}" includes="schema.xml"/>
		</torque-sql>
	</target>

	<!-- ================================================================ -->
	<!-- G E N E R A T E   D O C S                                        -->
	<!-- ================================================================ -->
	<!-- Generates documentation to                                       -->
	<!-- ${torque.doc.dir}/project-schema.html                            -->
	<!-- ================================================================ -->


	<target name="doc"
	        description="==> generates documentation for your datamodel"
			depends="inittasks"
	>

		<echo message="+------------------------------------------+" />
		<echo message="|                                          |" />
		<echo message="| Generating docs for YOUR datamodel!      |" />
		<echo message="|                                          |" />
		<echo message="+------------------------------------------+" />

		<mkdir dir="${torque.schema.dir}/doc" />

		<torque-doc contextProperties="${impex.contextProperties}"
		            controlTemplate="${torque.template.doc}"
		            outputDirectory="${torque.schema.dir}/doc"
		            outputFile="report.doc.generation"
		            outputFormat="${torque.doc.format}"
		            sqldbmap="${torque.sql.dir}/sqldb.map"
		            templatePath="${torque.templatePath}"
		            useClasspath="${torque.useClasspath}"
		>
			<fileset dir="${torque.schema.dir}" includes="schema.xml" />
		</torque-doc>
	</target>

	<!-- ================================================================ -->
	<!-- I N S E R T  S I N G L E  S Q L  F I L E S                       -->
	<!-- ================================================================ -->

	<target name="apply-ddl" description="==> inserts the generated sql "
			depends="inittasks"
		>

		<sql driver="${import.torque.database.driver}"
		     password="${import.torque.database.password}"
		     url="${import.torque.database.url}"
		     userid="${import.torque.database.user}"
		     delimiter="/"
		     delimitertype="row"
		     autocommit="false"
		     keepformat="true"
		     escapeprocessing="false"
		     onerror="continue"
		>
			<classpath refid="torque-classpath" />
			<fileset dir="${torque.schema.dir}/sql">
				<include name="schema.sql" />
			</fileset>
		</sql>

	</target>

	<target name="apply-constraint-ddl"
	        description="==> inserts the generated sql "
			depends="inittasks"
	>

		<sql driver="${import.torque.database.driver}"
		     password="${import.torque.database.password}"
		     url="${import.torque.database.url}"
		     userid="${import.torque.database.user}"
		     delimiter="/"
		     delimitertype="row"
		     autocommit="false"
		     keepformat="true"
		     escapeprocessing="false"
		     onerror="continue"
		>
			<classpath refid="torque-classpath" />
			<fileset dir="${torque.schema.dir}/sql">
				<include name="schema-constraints.sql" />
			</fileset>
		</sql>
	</target>

	<!-- ================================================================ -->
	<!-- J D B C  TO  X M L                                               -->
	<!-- ================================================================ -->

	<target name="jdbc-to-xml" description="==> jdbc to xml"
			depends="inittasks"
		>

		<echo message="+-----------------------------------------------+" />
		<echo message="|                                               |" />
		<echo message="| Generating XML from JDBC connection !         |" />
		<echo message="|                                               |" />
		<echo message="+-----------------------------------------------+" />

		<property name="torque.schema.absolute.dir" location="${torque.schema.dir}" />
		<!-- above works around a problem with torque-jdbc-transform getting passed a relative directory, and not working right if tbe process was started from a directory other than ant's basedir -->

		<torque-jdbc-transform dbDriver="${export.torque.database.driver}"
		                       dbPassword="${export.torque.database.password}"
		                       dbSchema="${export.torque.database.schema}"
		                       dbUrl="${export.torque.database.url}"
		                       dbUser="${export.torque.database.user}"
		                       outputFile="${torque.schema.absolute.dir}/schema.xml"
		                       sameJavaName="${torque.sameJavaName}" />
		<copy file="database.dtd" todir="${torque.schema.dir}" />
	</target>

	<!-- ================================================================ -->
	<!-- Dump data from database into xml file                            -->
	<!-- ================================================================ -->

	<target name="export-data" depends="inittasks,create-data-dtd"
		>
		<echo message="+-----------------------------------------------+" />
		<echo message="|                                               |" />
		<echo message="| Dumping the data from database into XML       |" />
		<echo message="|                                               |" />
		<echo message="+-----------------------------------------------+" />

		<property name="torque.output.absolute.dir" location="${torque.schema.dir}" />
		<!-- above works around a problem with torque-data-dump getting passed a relative directory, and not working right if tbe process was started from a directory other than ant's basedir -->
		<delete>
			<fileset dir="${torque.schema.dir}">
				<include name="*.xml" />
				<exclude name="schema.xml" />
			</fileset>
		</delete>

		<torque-data-dump databaseDriver="${export.torque.database.driver}"
		                  databaseUrl="${export.torque.database.url}"
		                  databaseUser="${export.torque.database.user}"
		                  databaseSchema="${export.torque.database.schema}"
		                  databasePassword="${export.torque.database.password}"
		                  outputDirectory="${torque.output.absolute.dir}"
		/>

		<!-- remove files for empty tables -->
		<delete>
			<fileset dir="${torque.schema.dir}">
				<and>
					<filename name="*.xml" />
					<size when="less" value="80" />
					<!-- empty except for body tags -->
				</and>
			</fileset>
		</delete>
	</target>

	<target name="package-export">
		<delete file="${target.zip}"
		        failonerror="false"
		/>
		<zip destfile="${target.zip}"
		     whenempty="fail"
		>
			<fileset dir="${torque.schema.dir}">
				<include name="*.xml" />
				<include name="doc/**/*" />
				<exclude name="**/*.generation" />
			</fileset>
			<fileset dir="${torque.schema.dir}">
				<include name="*.dtd" />
				<include name="schema.xml" />
			</fileset>
		</zip>
	</target>
	<!-- ================================================================ -->
	<!-- G E N E R A T E  P R O J E C T  D A T A  D T D                   -->
	<!-- ================================================================ -->
	<!-- Generate the DATA DTD for your project                           -->
	<!-- ================================================================ -->

	<target name="create-data-dtd"
	        description="==> generates the DATA DTD for your project"
			depends="inittasks"
	>

		<echo message="+-----------------------------------------------+" />
		<echo message="|                                               |" />
		<echo message="| Generating Data DTD for YOUR Torque project!  |" />
		<echo message="|                                               |" />
		<echo message="+-----------------------------------------------+" />

		<echo message="${torque.template.dataDtd}" />
		<torque-data-model contextProperties="${impex.contextProperties}"
		                   controlTemplate="${torque.template.dataDtd}"
		                   outputDirectory="${torque.schema.dir}"
		                   outputFile="report.datadtd.generation"
		                   templatePath="${torque.templatePath}"
		                   useClasspath="${torque.useClasspath}"
		                   xmlFile="${torque.schema.dir}/schema.xml"
		/>
	</target>

	<!-- ================================================================ -->
	<!-- Generate SQL from XML data file                                  -->
	<!-- ================================================================ -->

	<target name="dataxml-to-sql" description="==> generates sql from data xml" depends="inittasks">

		<echo message="+-----------------------------------------------+" />
		<echo message="|                                               |" />
		<echo message="| Generating SQL from data XML !                |" />
		<echo message="|                                               |" />
		<echo message="+-----------------------------------------------+" />
		<mkdir dir="${torque.schema.dir}/datasql"/>
		
        <torque-data-sql
            contextProperties="${impex.contextProperties}"
            controlTemplate="${torque.template.dataSql}"
            dataDTD="${torque.schema.dir}/data.dtd"
            outputDirectory="${torque.schema.dir}/datasql"
            sqldbmap="${torque.sql.dir}/sqldb.map"
            targetDatabase="${import.torque.database}"
            templatePath="${torque.templatePath}"
            useClasspath="${torque.useClasspath}"
            xmlFile="${torque.schema.dir}/schema.xml" >
            <fileset dir="${torque.schema.dir}" 
               includes="*.xml" excludes="schema.xml" />

        </torque-data-sql>
		
		<!-- due to the size of the data, there is no way to load it all at once.  Somewhere in the process,
  	     previously output data is not being purged from the VM (somewhere in Torque or Velocity).  So, the indirect way of creating the files
  	     below invokes a separate VM for each file -->
		<!--
		<foreach target="external-run-dataxml-load"
		         inheritall="true"
		         param="xmlDataFile"
		         parallel="true"
		         maxthreads="5"
		>
			<path>
				<fileset dir="${torque.schema.dir}" excludes="${import.exclude.data.pattern}">
					<include name="*.xml" />
					<exclude name="schema.xml" />
				</fileset>
			</path>
		</foreach>
        -->

	</target>

	<target name="apply-data-sql" depends="inittasks">
		<sql driver="${import.torque.database.driver}"
		     password="${import.torque.database.password}"
		     url="${import.torque.database.url}"
		     userid="${import.torque.database.user}"
		     delimiter="/"
		     delimitertype="row"
		     autocommit="false"
		     keepformat="true"
		     escapeprocessing="false"
		     onerror="continue"
		>
			<classpath refid="torque-classpath" />
			<fileset dir="${torque.schema.dir}/datasql">
				<include name="*.sql" />
			</fileset>
		</sql>
	</target>

	<target name="unpack-export">
		<delete dir="${torque.schema.dir}/datasql" failonerror="no" />
		<delete dir="${torque.schema.dir}/sql" failonerror="no" />

		<unzip dest="${torque.schema.dir}"
		       src="${source.zip}"
		       overwrite="true"
		/>
	</target>

	<target name="import"
	        depends="check-import-properties,create-ddl,apply-ddl,dataxml-to-sql,apply-data-sql,apply-constraint-ddl"
	        description="==> Main Import Task"
	>
	</target>

	<target name="export"
	        depends="check-export-properties,jdbc-to-xml,export-data,doc"
	        description="==> Main Export Task - doesn't work when using OCI JDBC connection"
	>
		<delete>
			<fileset dir="${torque.schema.dir}" includes="**/*.generation" />
		</delete>
	</target>

	<target name="check-import-properties" depends="inittasks">
		<condition property="import.properties.set">
			<and>
				<isset property="import.torque.database"/>
				<isset property="import.torque.database.driver"/>
				<isset property="import.torque.database.url"/>
				<isset property="import.torque.database.user"/>
				<isset property="import.torque.database.schema"/>
				<isset property="import.torque.database.password"/>
			</and>
		</condition>

		<fail unless="import.properties.set">.
			
Import properties not set.  
			
Please place an impex-build.properties in your home directory (${user.home}) with the properties in impex-build.properties.sample.
		</fail>

		<fail>
			<condition>
				<not>
					<available classname="${import.torque.database.driver}" classpathref="torque-classpath" />
				</not>
			</condition>
			.
			
Unable to find import database driver class.  (${import.torque.database.driver}) 
			
Please place the jar file for this class in the lib directory and try again.
		</fail>
		<antcall target="test-${import.torque.database}-connection" />
	</target>
	
	<target name="test-oracle-connection">
		<sql driver="${import.torque.database.driver}"
		     password="${import.torque.database.password}"
		     url="${import.torque.database.url}"
		     userid="${import.torque.database.user}"
		     onerror="abort"
			 classpathref="torque-classpath"
		>SELECT dummy FROM dual</sql>		
	</target>

	<target name="test-mysql-connection">
		<sql driver="${import.torque.database.driver}"
		     password="${import.torque.database.password}"
		     url="${import.torque.database.url}"
		     userid="${import.torque.database.user}"
		     onerror="abort"
			 classpathref="torque-classpath"
		>SELECT 1</sql>		
	</target>
	
	<target name="check-export-properties" depends="inittasks">
		<condition property="export.properties.set">
			<and>
				<isset property="export.torque.database"/>
				<isset property="export.torque.database.driver"/>
				<isset property="export.torque.database.url"/>
				<isset property="export.torque.database.user"/>
				<isset property="export.torque.database.schema"/>
				<isset property="export.torque.database.password"/>
			</and>
		</condition>

		<fail unless="export.properties.set">.
			
Export properties not set.  
			
Please place an impex-build.properties in your home directory (${user.home}) with the properties in impex-build.properties.sample 
properly set for your database instance.
		</fail>

		<fail>
			<condition>
				<not>
					<available classname="${export.torque.database.driver}" classpathref="torque-classpath" />
				</not>
			</condition>
			.
			
Unable to find export database driver class.  (${export.torque.database.driver}) 
			
Please place the jar file for this class in the lib directory and try again.
		</fail>
	</target>

	<target name="clean">
		<delete dir="${torque.schema.dir}" failonerror="false" />
	</target>
</project>
