#!/bin/bash

function dismount_existing {
  if mountpoint -q $OLD_SSD_MOUNT; then
    echo "unmount   -> $OLD_SSD_MOUNT"
    execute_quietly "umount $OLD_SSD_MOUNT"
  fi

  if mountpoint -q $NEW_SSD_MOUNT; then
    echo "unmount   -> $NEW_SSD_MOUNT"
    execute_quietly "umount $NEW_SSD_MOUNT"
  fi
}

function create_ssd_mount {
  echo "raid 0    -> create stripe"
  MDADM_COMMAND="yes | mdadm --create --verbose /dev/md/ssd --level=stripe --raid-devices=2 /dev/xvdb /dev/xvdc"
  if [ "$QUIET" == "true" ]; then
    $MDADM_COMMAND > /dev/null 2>&1 
  else
    $MDADM_COMMAND 
  fi
  echo "create    -> filesystem"
  execute_quietly "mkfs.ext3 /dev/md/ssd" 
  execute_quietly "mkdir -p $NEW_SSD_MOUNT"
  execute_quietly "mount /dev/md/ssd $NEW_SSD_MOUNT"
  execute_quietly "rm -rf $OLD_SSD_MOUNT"
}

MY_DIR="$( cd "$( dirname "$0" )" && pwd )"
ME=$(basename $0)
source $MY_DIR/functions.sh

QUIET=$1
if [ "$QUIET" == "-q" ]; then
  QUIET=true
fi

OLD_SSD_MOUNT="/mnt"
NEW_SSD_MOUNT="/ssd"

echo "packages  -> mdadm"
execute_quietly "apt-get install mdadm -y --no-install-recommends"

dismount_existing
create_ssd_mount
