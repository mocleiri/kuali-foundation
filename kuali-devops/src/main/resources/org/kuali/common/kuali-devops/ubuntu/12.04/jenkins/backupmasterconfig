function check_args {
  check_not_blank STACK $STACK
  check_not_blank VERSION $VERSION
  check_not_blank GPG_PASSPHRASE $GPG_PASSPHRASE
}

function tar_config {
   echo "tar.gz    -> /home/tomcat7/.jenkins"
   execute_quietly "rm -rf /ssd/master.*"
   execute_quietly "cd /home/tomcat7"
   execute_quietly "tar -zvcf $TAR_FILE .jenkins --exclude=**/plugins/** --exclude=**/workspace/** --exclude=**/logs/slaves/**"
   execute_quietly "cd $MY_DIR"
}


MY_DIR="$( cd "$( dirname "$0" )" && pwd )"
ME=$(basename $0)
source $MY_DIR/../common/functions.sh

usage() { echo "Usage: $ME [-q --quiet] [-h --help] stack version password" 1>&2; exit 1; }

QUIET=false

ARGS=$(getopt --options hqa:p:t:c: --longoptions "help,quiet,acl:,prefix:,type:,classifier:" --name "$ME" -- "$@");
if [ $? -ne 0 ]; then usage; fi
eval set -- "$ARGS";
while true; do
  case "$1" in
    -h|--help)
      usage;
      shift;
      ;;
    -q|--quiet)
      QUIET=true;
      shift;
      ;;
    --)
      shift;
      break;
      ;;
  esac
done

STACK=$1
VERSION=$2
GPG_PASSPHRASE=$3

check_args

QUIET_FLAG=""
if [ "$QUIET" == "true" ]; then
  QUIET_FLAG="-q"
fi

GROUP_ID=org.jenkins
ARTIFACT_ID=jenkins-master-backup
CLASSIFIER=$STACK-$TIMESTAMP
TYPE=tar.gz.gpg

PREFIX=external
ACCESS_KEY=AKIAJFD5IM7IPVVUEBNA
SECRET_KEY=jA0ECQMCH+1hmsTpTJBg0l0Bm4TN02PIJ4thS5r2Vil00WzxLK3zzx1Ex1VPwCm9piYBThswdQ4w5YerNyzX5dApt2R/7tkefO6qh5BF/Tsj5033CmrpFQO8lwfLOvGVymZQh7YSZ8fYXSNFK5M=
SECRET_KEY=$(decrypt $SECRET_KEY $GPG_PASSPHRASE)
BUCKET=maven.kuali.org

TAR_FILE=/ssd/master.tar.gz
tar_config
GPG_DECRYPTED=$TAR_FILE
GPG_ENCRYPTED=$TAR_FILE.gpg
encrypt_file $GPG_DECRYPTED $GPG_ENCRYPTED

$MY_DIR/../common/m2s3upload $QUIET_FLAG $GPG_ENCRYPTED $ACCESS_KEY $SECRET_KEY $BUCKET $GROUP_ID $ARTIFACT_ID $VERSION --type=$TYPE --prefix=$PREFIX
