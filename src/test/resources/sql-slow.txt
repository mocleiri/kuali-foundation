====
    Copyright 2010-2013 The Kuali Foundation

    Licensed under the Educational Community License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.opensource.org/licenses/ecl2.php

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
====

[INFO] Elapsed: 17.456m [UPDATE KSEN_LUI updatef SET CLU_ID=\n(SELECT\n    newMatch.fid newformatId\nFROM\n    (\n        SELECT\n            CO_ID,\n            newCLU_ID,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    newCLU_ID,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN cfr,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID,\n                            newC.id newClu_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newCLU_ID = cfr.CLU_ID\n                AND F.ID = cfr.RELATED_CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    newCLU_ID,\n                    fid,\n                    atype\n            )\n        GROUP BY\n            CO_ID,\n            newCLU_ID,\n            fid\n    )\n    newMatch,\n    (\n        SELECT\n            CO_ID,\n            foid,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    fo.id foid,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSEN_LUI fo,\n                    KSEN_LUILUI_RELTN cofor,\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newmap.CO_ID = cofor.LUI_ID\n                AND fo.ID = cofor.RELATED_LUI_ID\n                AND F.ID = fo.CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    FOID,\n                    FID,\n                    ATYPE\n            )\n        GROUP BY\n            CO_ID,\n            FOID,\n            FID\n    )\n    oldMatch\nWHERE\n    newmatch.CO_ID(+)=oldmatch.co_ID\nAND newmatch.atype(+)=oldmatch.atype\nand oldmatch.foid=updatef.id)\nwhere\nupdatef.id in\n(SELECT\n    oldMatch.foid\nFROM\n    (\n        SELECT\n            CO_ID,\n            newCLU_ID,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    newCLU_ID,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN cfr,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID,\n                            newC.id newClu_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newCLU_ID = cfr.CLU_ID\n                AND F.ID = cfr.RELATED_CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    newCLU_ID,\n                    fid,\n                    atype\n            )\n        GROUP BY\n            CO_ID,\n            newCLU_ID,\n            fid\n    )\n    newMatch,\n    (\n        SELECT\n            CO_ID,\n            foid,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    fo.id foid,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSEN_LUI fo,\n                    KSEN_LUILUI_RELTN cofor,\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newmap.CO_ID = cofor.LUI_ID\n                AND fo.ID = cofor.RELATED_LUI_ID\n                AND F.ID = fo.CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    FOID,\n                    FID,\n                    ATYPE\n            )\n        GROUP BY\n            CO_ID,\n            FOID,\n            FID\n    )\n    oldMatch\nWHERE\n    newmatch.CO_ID(+)=oldmatch.co_ID\nAND newmatch.atype(+)=oldmatch.atype)]
[INFO] Elapsed: 3.787s [update KSEN_LUI l set l.EFF_DT=(Select a.START_DT from KSEN_ATP a where a.id=l.ATP_ID) where l.EFF_DT is null]
[INFO] Elapsed: 3.534s [UPDATE KSEN_LUI_ATTR set ATTR_VALUE='kuali.lui.type.activity.offering.lecture' where ATTR_VALUE='kuali.lui.type.activity.offering.LectureORSeminar']
[INFO] Elapsed: 3.290s [DELETE\n    KSLU_CLUCLU_RELTN cr\nWHERE\n    RELATED_CLU_ID IN\n    (\n        SELECT\n            fid\n        FROM\n            (\n                SELECT\n                    COUNT(fo.id) foc,\n                    courses.cid,\n                    courses.fid,\n                    courses.activities,\n                    ROW_NUMBER() over (partition BY courses.cid, activities ORDER BY activities,\n                    COUNT( fo.id) DESC) r\n                FROM\n                    KSEN_LUI fo,\n                    (\n                        SELECT\n                            cid,\n                            fid,\n                            stragg(atype) activities\n                        FROM\n                            (\n                                SELECT\n                                    c.id cid,\n                                    f.id fid,\n                                    a.LUTYPE_ID atype\n                                FROM\n                                    KSLU_CLU c,\n                                    KSLU_CLU f,\n                                    KSLU_CLU a,\n                                    KSLU_CLUCLU_RELTN cfr,\n                                    KSLU_CLUCLU_RELTN far\n                                WHERE\n                                    c.id = cfr.CLU_ID\n                                AND f.id = cfr.RELATED_CLU_ID\n                                AND f.id = far.clu_id\n                                AND a.id = far.RELATED_CLU_ID\n                                AND f.LUTYPE_ID='kuali.lu.type.CreditCourseFormatShell'\n                                ORDER BY\n                                    cid,\n                                    fid,\n                                    atype\n                            )\n                        GROUP BY\n                            cid,\n                            fid\n                    )\n                    courses\n                WHERE\n                    fo.CLU_ID(+)=courses.fid\n                GROUP BY\n                    courses.cid,\n                    courses.fid,\n                    courses.activities\n            )\n        WHERE\n            r>1\n        AND foc=0\n    )]
[INFO] Elapsed: 2.373s [UPDATE\n    KSEN_LUI\nSET\n    LUI_STATE='kuali.lui.format.offering.state.offered'\nWHERE\n    LUI_TYPE='kuali.lui.type.course.format.offering'\nAND LUI_STATE ='kuali.lui.activity.offering.state.offered']
[INFO] Elapsed: 2.103s [update KRMS_REF_OBJ_KRMS_OBJ_T o set o.REF_OBJ_ID=\n(SELECT\n    courses.ID\nFROM\n    (\n        SELECT\n            a.REF_OBJ_KRMS_OBJ_ID,\n            rownum r\n        FROM\n            KRMS_REF_OBJ_KRMS_OBJ_T a\n    )\n    ros,\n    (\n        SELECT\n            s.*,\n            rownum r\n        FROM\n            (\n                SELECT\n                    ID,\n                    VER_IND_ID\n                FROM\n                    KSLU_CLU c\n                WHERE\n                    c.LUTYPE_ID='kuali.lu.type.CreditCourse'\n                AND c.ST='Active'\n                AND c.EXPIR_DT IS NULL\n                ORDER BY\n                    id ASC\n            )\n            s\n    )\n    courses\nwhere courses.r=ros.r\nand ros.REF_OBJ_KRMS_OBJ_ID = o.REF_OBJ_KRMS_OBJ_ID)]
[INFO] Elapsed: 1.657s [UPDATE KSEN_LUI l set CLU_ID=(\nSELECT\n    newC.id\nFROM\n    KSLU_CLU oldC,\n    KSLU_CLU newC,\n    KSEN_LUI co,\n    KSEN_ATP coAtp,\n    KSEN_ATP newCStartTerm,\n    KSEN_ATP newCEndTerm\nWHERE\n    l.id=co.id\nAND co.CLU_ID = oldC.ID\nAND co.ATP_ID = coAtp.ID\nAND oldC.VER_IND_ID = newC.VER_IND_ID\nAND newC.EXP_FIRST_ATP = newCStartTerm.ID\nAND newC.LAST_ATP = newCEndTerm.ID(+)\nAND coAtp.START_DT >= newCStartTerm.START_DT\nAND\n    (\n        newCEndTerm.END_DT IS NULL\n     OR newCEndTerm.END_DT>coAtp.START_DT\n    )\nand oldC.ID!=newC.ID)\nWHERE\nl.LUI_TYPE='kuali.lui.type.course.offering' and\n EXISTS(\nSELECT\n    co.ID CO_ID, oldC.ID oldClu, newC.id newClu_ID, co.LUI_TYPE, co.ATP_ID LUI_ATP, newCStartTerm.ID,newCEndTerm.ID\nFROM\n    KSLU_CLU oldC,\n    KSLU_CLU newC,\n    KSEN_LUI co,\n    KSEN_ATP coAtp,\n    KSEN_ATP newCStartTerm,\n    KSEN_ATP newCEndTerm\nWHERE\n    l.id=co.id\nAND co.CLU_ID = oldC.ID\nAND co.ATP_ID = coAtp.ID\nAND oldC.VER_IND_ID = newC.VER_IND_ID\nAND newC.EXP_FIRST_ATP = newCStartTerm.ID\nAND newC.LAST_ATP = newCEndTerm.ID(+)\nAND coAtp.START_DT >= newCStartTerm.START_DT\nAND\n    (\n        newCEndTerm.END_DT IS NULL\n     OR newCEndTerm.END_DT>coAtp.START_DT\n    )\nand oldC.ID!=newC.ID)]
[INFO] Elapsed: 1.468s [DELETE KSLU_CLU_ATTR WHERE KSLU_CLU_ATTR.OWNER IN (SELECT far.RELATED_CLU_ID FROM KSLU_CLUCLU_RELTN far where far.CLU_ID IN(SELECT orphanF.ID FROM KSLU_CLU orphanf WHERE orphanf.LUTYPE_ID='kuali.lu.type.CreditCourseFormatShell' AND NOT EXISTS (SELECT * FROM KSLU_CLUCLU_RELTN orphanfrel WHERE orphanfrel.RELATED_CLU_ID=orphanf.id)))]
