UPDATE KSEN_LUI updatef SET CLU_ID=\n(SELECT\n    newMatch.fid newformatId\nFROM\n    (\n        SELECT\n            CO_ID,\n            newCLU_ID,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    newCLU_ID,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN cfr,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID,\n                            newC.id newClu_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newCLU_ID = cfr.CLU_ID\n                AND F.ID = cfr.RELATED_CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    newCLU_ID,\n                    fid,\n                    atype\n            )\n        GROUP BY\n            CO_ID,\n            newCLU_ID,\n            fid\n    )\n    newMatch,\n    (\n        SELECT\n            CO_ID,\n            foid,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    fo.id foid,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSEN_LUI fo,\n                    KSEN_LUILUI_RELTN cofor,\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newmap.CO_ID = cofor.LUI_ID\n                AND fo.ID = cofor.RELATED_LUI_ID\n                AND F.ID = fo.CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    FOID,\n                    FID,\n                    ATYPE\n            )\n        GROUP BY\n            CO_ID,\n            FOID,\n            FID\n    )\n    oldMatch\nWHERE\n    newmatch.CO_ID(+)=oldmatch.co_ID\nAND newmatch.atype(+)=oldmatch.atype\nand oldmatch.foid=updatef.id)\nwhere\nupdatef.id in\n(SELECT\n    oldMatch.foid\nFROM\n    (\n        SELECT\n            CO_ID,\n            newCLU_ID,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    newCLU_ID,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN cfr,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID,\n                            newC.id newClu_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newCLU_ID = cfr.CLU_ID\n                AND F.ID = cfr.RELATED_CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    newCLU_ID,\n                    fid,\n                    atype\n            )\n        GROUP BY\n            CO_ID,\n            newCLU_ID,\n            fid\n    )\n    newMatch,\n    (\n        SELECT\n            CO_ID,\n            foid,\n            fid,\n            stragg(atype) atype\n        FROM\n            (\n                SELECT\n                    CO_ID,\n                    fo.id foid,\n                    f.id fid,\n                    a.LUTYPE_ID atype\n                FROM\n                    KSEN_LUI fo,\n                    KSEN_LUILUI_RELTN cofor,\n                    KSLU_CLU f,\n                    KSLU_CLU a,\n                    KSLU_CLUCLU_RELTN far,\n                    (\n                        SELECT\n                            co.ID CO_ID\n                        FROM\n                            KSLU_CLU oldC,\n                            KSLU_CLU newC,\n                            KSEN_LUI co,\n                            KSEN_ATP coAtp,\n                            KSEN_ATP newCStartTerm,\n                            KSEN_ATP newCEndTerm\n                        WHERE\n                            co.CLU_ID = oldC.ID\n                        AND co.ATP_ID = coAtp.ID\n                        AND oldC.VER_IND_ID = newC.VER_IND_ID\n                        AND newC.EXP_FIRST_ATP = newCStartTerm.ID\n                        AND newC.LAST_ATP = newCEndTerm.ID(+)\n                        AND coAtp.START_DT >= newCStartTerm.START_DT\n                        AND\n                            (\n                                newCEndTerm.END_DT IS NULL\n                             OR newCEndTerm.END_DT>coAtp.START_DT\n                            )\n                        AND oldC.ID!=newC.ID\n                    )\n                    newmap\n                WHERE\n                    newmap.CO_ID = cofor.LUI_ID\n                AND fo.ID = cofor.RELATED_LUI_ID\n                AND F.ID = fo.CLU_ID\n                AND F.ID = far.CLU_ID\n                AND A.ID = far.RELATED_CLU_ID\n                ORDER BY\n                    CO_ID,\n                    FOID,\n                    FID,\n                    ATYPE\n            )\n        GROUP BY\n            CO_ID,\n            FOID,\n            FID\n    )\n    oldMatch\nWHERE\n    newmatch.CO_ID(+)=oldmatch.co_ID\nAND newmatch.atype(+)=oldmatch.atype)]
